#!/usr/bin/env python
"""
Usage:
    fetch-connections [options]

Options:
    --rounds=INT    number of iterations [default: 1]
    --delay=INT     delay in seconds [default: 30]
"""

from __future__ import print_function

from datetime import (datetime, timedelta)
import time

from docopt import docopt

from netkraken.db import Fetcher, Aggregator

arguments = docopt(__doc__)
delta = timedelta(seconds=int(arguments["--delay"]))
rounds = int(arguments["--rounds"])

start = datetime.now()
next_start = None

aggregator = Aggregator()
for nr in range(0, rounds):
    now = datetime.now()
    if next_start:
        next_start = start + nr * delta
    else:
        next_start = now
    if now > next_start:
        continue
    td = next_start - now
    seconds_to_wait = (td.microseconds + (td.seconds + td.days * 24 * 3600) * 10**6) / 10**6
    # print("waiting for %i seconds..." % seconds_to_wait)
    time.sleep(seconds_to_wait)

    print("round %i / %i" % (nr, rounds))
    cf = Fetcher()
    cf.fetch()
    aggregator.aggregate()
