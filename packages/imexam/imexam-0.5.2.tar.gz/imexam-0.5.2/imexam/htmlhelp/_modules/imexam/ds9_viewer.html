<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>imexam.ds9_viewer &mdash; imexam v0.5</title>
    
    <link rel="stylesheet" href="../../_static/bootstrap-astropy.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/sidebar.js"></script>
    <link rel="shortcut icon" href="../../_static/astropy_logo.ico"/>
    <link rel="top" title="imexam v0.5" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" />
<link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'>
<script type="text/javascript" src="../../_static/copybutton.js"></script>


  </head>
  <body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../../index.html"><span id="logotext1">astro</span><span id="logotext2">py</span><span id="logotext3">:docs</span></a>
  <ul>
    <li><a class="homelink" title="Astropy Homepage" href="http://www.astropy.org"></a></li>
    <li><a title="General Index" href="../../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li>
	<a href="../../index.html">imexam v0.5</a>
	 &raquo;
      </li>
      <li><a href="../index.html" accesskey="U">Module code</a> &raquo;</li>
      
       
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for imexam.ds9_viewer</h1><div class="highlight"><pre>
<span class="c"># Licensed under a 3-clause BSD style license - see LICENSE.rst</span>

<span class="sd">&quot;&quot;&quot;This class supports communication with DS9 through the XPA</span>


<span class="sd">Some code in this class was adapted from pysao, which can be found at https://github.com/leejjoon/pysao.</span>
<span class="sd">Specifically this package used the existing Cython implementation to the XPA  and extended the calls to</span>
<span class="sd">the other available XPA executables so that more functionality is added. The same information is available</span>
<span class="sd">here: http://hea-www.harvard.edu/RD/xpa/client.html#xpaopen</span>

<span class="sd">Using Cython will allow for broader development of the code and produce faster runtimes for large datasets</span>
<span class="sd">with repeated calls to the display manager.</span>

<span class="sd">XPA is licensed under LGPL, help can be found here: http://hea-www.cfa.harvard.edu/saord/xpa/help.html</span>
<span class="sd">The current XPA can be downloaded from here: http://hea-www.harvard.edu/saord/xpa/</span>

<span class="sd">DS9 also supports the SAMP protocol, but that has not been fully implemented in this package. http://ds9.si.edu/doc/ref/samp.html</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">absolute_import</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">Popen</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">tempfile</span> <span class="kn">import</span> <span class="n">mkdtemp</span>

<span class="kn">import</span> <span class="nn">imexam.xpa_wrap</span> <span class="kn">as</span> <span class="nn">xpa</span>
<span class="kn">from</span> <span class="nn">imexam.xpa</span> <span class="kn">import</span> <span class="n">XpaException</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">util</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>


<span class="k">class</span> <span class="nc">UnsupportedDatatypeException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">UnsupportedImageShapeException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;ds9&#39;</span><span class="p">]</span>


<span class="c"># make a new object for every window you want to create</span>

<div class="viewcode-block" id="ds9"><a class="viewcode-back" href="../../api/imexam.ds9_viewer.ds9.html#imexam.ds9_viewer.ds9">[docs]</a><span class="k">class</span> <span class="nc">ds9</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot; A class which controls all interactions between the user and the ds9 window</span>

<span class="sd">        The ds9() contructor takes a ds9 target as its main argument. If none is given,</span>
<span class="sd">        then a new window will be opened.</span>

<span class="sd">        DS9&#39;s xpa access points are documented in the reference manual, but the can also</span>
<span class="sd">        be returned to the user with a call to xpaset.</span>

<span class="sd">        http://hea-www.harvard.edu/saord/ds9/ref/xpa.html</span>


<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        target: string, optional</span>
<span class="sd">             the ds9 target name or id (default is to start a new instance)</span>

<span class="sd">        path : string, optional</span>
<span class="sd">            path of the ds9</span>

<span class="sd">        wait_time : float, optional</span>
<span class="sd">            waiting time before error is raised</span>

<span class="sd">        quit_ds9_on_del : boolean, optional</span>
<span class="sd">            If True, try to quit ds9 when this instance is deleted.</span>


<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>

<span class="sd">        wait_time: float</span>
<span class="sd">             The waiting time before error is raised</span>

<span class="sd">        path: string</span>
<span class="sd">            The path to the DS9 executable</span>

<span class="sd">        _xpa_name: string</span>
<span class="sd">            The value in XPA_METHOD, the name of the DS9 window</span>

<span class="sd">        _quit_ds9_on_del: boolean</span>
<span class="sd">             Determine whether to quit ds9 when object goes out of scope.</span>

<span class="sd">        _ds9_unix_name: string</span>
<span class="sd">            The full path filename to the unix socket, only if unix sockets are being used with local</span>

<span class="sd">        _need_to_purge: boolean</span>
<span class="sd">             whenever there are unix socket directories which need to be purged when the object goes out of scope</span>

<span class="sd">        _tmpd_name: string</span>
<span class="sd">            The full path name to the unix socket file on the local system</span>

<span class="sd">        _filename: string</span>
<span class="sd">            The name of the image that&#39;s currently loaded into DS9</span>

<span class="sd">        _ext: int</span>
<span class="sd">            Extension of the current image that is loaded. If one extension of an MEF file is loaded this will be 1</span>
<span class="sd">            regarless of the extension that was specified (because DS9 and the XPA now see it as a single image and header)</span>

<span class="sd">        _extname: string</span>
<span class="sd">            If available, the EXTNAME of the MEF extension that is loaded, taken from the current data header</span>

<span class="sd">        _extver: int</span>
<span class="sd">            If available, the EXTVER of the MEF extension that is loaded, taken from the current data header</span>

<span class="sd">        _ds9_process: pointer</span>
<span class="sd">            Points to the ds9 process id on the system, returned by Popen, whenever this module starts DS9</span>

<span class="sd">        _mef_file: boolean</span>
<span class="sd">            The file is a multi-extension fits file</span>

<span class="sd">        _iscube: bookean</span>
<span class="sd">            The file is a multiextension fits file, and one of the extensions contains at least 1 additional extension (3D or more)</span>

<span class="sd">        _numaxis: int</span>
<span class="sd">            number of image planes, this is NAXIS</span>

<span class="sd">        _naxis: tuple</span>
<span class="sd">            specific image plane displayed, defaulted to 1 image plane, most relevant to cube fits files</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># _ImgCode : copied from fits, used for displaying arrays straight to DS9</span>
    <span class="n">_ImgCode</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;float32&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">32</span><span class="p">,</span>
                <span class="s">&#39;float64&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">64</span><span class="p">,</span>
                <span class="s">&#39;float16&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">16</span><span class="p">,</span>
                <span class="s">&#39;int16&#39;</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span>
                <span class="s">&#39;int32&#39;</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span>
                <span class="s">&#39;int64&#39;</span><span class="p">:</span> <span class="mi">64</span><span class="p">,</span>
                <span class="s">&#39;uint8&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">}</span>

    <span class="n">_tmp_dir</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
    <span class="n">_process_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">wait_time</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                 <span class="n">quit_ds9_on_del</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        I think this is a quirk in the XPA communication. The xpans, and XPA prefer to have all connections</span>
<span class="sd">        be of the same type. DS9 defaults to creating an INET connection. In some cases, if no IP address can be</span>
<span class="sd">        found for the computer, the startup can hang. In these cases, a local connection is preferred, which</span>
<span class="sd">        uses a unix filename for the socket.</span>

<span class="sd">        The problem arises that if the user already has DS9 windows running, that were started by default, the nameserver</span>
<span class="sd">        is only listening for the default socket type (inet) and not local. There are also cases where the machine</span>
<span class="sd">        running this code does not have xpa installed, so there is no xpans (nameserver) to run and keep track of the</span>
<span class="sd">        open connections. In that case, the user needs to provide this init with the name of the socket in their</span>
<span class="sd">        window (in XPA_METHOD) in order to create the connection.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_quit_ds9_on_del</span> <span class="o">=</span> <span class="n">quit_ds9_on_del</span>  <span class="c"># determine whether to quit ds9 also when object deleted.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_time</span> <span class="o">=</span> <span class="n">wait_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_need_to_purge</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tmpd_name</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c"># dictionary where each key is a frame number, and the values are a dictionary of details</span>
        <span class="c"># about the image loaded in that frame</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_frame</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_slice</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c"># default starting socket type to local in order get around user xpa</span>
        <span class="c"># installation issues</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_xpa_method</span> <span class="o">=</span> <span class="s">&quot;local&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_xpa_name</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="c"># only used for DS9 windows started from this module</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ds9_process</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ds9_path</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ds9_path</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">find_ds9</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds9_path</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s">&quot;Could not find ds9 executable on your path&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ds9_path</span> <span class="o">=</span> <span class="n">path</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">target</span><span class="p">:</span>
            <span class="c"># Check to see if the user has chosen a preference first</span>
            <span class="k">if</span> <span class="s">&#39;XPA_METHOD&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_xpa_method</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;XPA_METHOD&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

            <span class="k">if</span> <span class="s">&#39;inet&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xpa_method</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_xpa_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_inet_ds9</span><span class="p">()</span>
                <span class="c"># xpa_name is the title of the window, the xpa can be referenced</span>
                <span class="c"># with either the socket address or name of the window</span>

            <span class="k">elif</span> <span class="s">&#39;local&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xpa_method</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_xpa_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds9_unix_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_unixonly_ds9</span><span class="p">()</span>

            <span class="c"># tells xpa where to find sockets</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;XPA_METHOD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xpa_method</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c"># just register with the target the user provided</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_xpa_name</span> <span class="o">=</span> <span class="n">target</span>

        <span class="c"># xpa_name sets the template for the get and set commands</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xpa</span> <span class="o">=</span> <span class="n">xpa</span><span class="o">.</span><span class="n">XPA</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_xpa_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&#39;local&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xpa_method</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_frameinfo</span><span class="p">()</span>  <span class="c"># initial load</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_define_cmaps</span><span class="p">()</span>  <span class="c"># dictionary of color maps</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quit_ds9_on_del</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&#39;local&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xpa_method</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_purge_local</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_stop_process</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_set_frameinfo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the name and extension information for the data displayed in the current frame</span>
<span class="sd">        and gather header information</span>


<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        The absolute path reference is stored to make XPA happy in all cases, wherever the user</span>
<span class="sd">        started the DS9 process.</span>

<span class="sd">        The only consistant way to return which cube and slice that is displayed is with the call</span>
<span class="sd">        to &quot;file&quot; which has the full plane=x:y information, but only when looking at something</span>
<span class="sd">        other than the first extension for each plane. In this case, you have to look at the header</span>
<span class="sd">        information to see it&#39;s a cube image, and assume the first image plane is displayed.</span>

<span class="sd">        If you load a single extension from an MEF into DS9, XPA references the extension as 1 afterwards for access points</span>
<span class="sd">        you need to look in the header of the displayed image to find out what the actual extension that is loaded is</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># check the current frame, if none exists, then don&#39;t continue</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">frame</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">frame</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="p">[</span><span class="n">frame</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">user_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="p">[</span><span class="n">frame</span><span class="p">][</span><span class="s">&#39;user_array&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">user_array</span> <span class="o">=</span> <span class="bp">None</span>

            <span class="n">extver</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c"># extension number</span>
            <span class="n">extname</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c"># name of extension</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c"># filename of image</span>
            <span class="n">numaxis</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c"># number of image planes, this is NAXIS</span>
            <span class="c"># tuple of each image plane, defaulted to 1 image plane</span>
            <span class="n">naxis</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="c"># data has more than 2 dimensions and loads in cube/slice frame</span>
            <span class="n">iscube</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">mef_file</span> <span class="o">=</span> <span class="bp">False</span>  <span class="c"># used to check misleading headers in fits files</span>

            <span class="n">load_header</span> <span class="o">=</span> <span class="bp">False</span>  <span class="c"># not used for in memory arrays</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_current_frame</span> <span class="o">=</span> <span class="n">frame</span>

            <span class="c"># see if any file is currently loaded into ds9, xpa returns &#39;\n&#39; for nothing loaded</span>
            <span class="c"># get the current frame</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">filename_string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;file&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filename_string</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">filename</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">filename_string</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;[&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="p">[</span><span class="n">frame</span><span class="p">][</span><span class="s">&#39;filename&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                    <span class="n">load_header</span> <span class="o">=</span> <span class="bp">True</span>

            <span class="k">except</span> <span class="n">XpaException</span><span class="p">:</span>
                <span class="n">filename_string</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="s">&quot;plane&quot;</span> <span class="ow">in</span> <span class="n">filename_string</span><span class="p">:</span>
                    <span class="n">iscube</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">if</span> <span class="s">&quot;:&quot;</span> <span class="ow">in</span> <span class="n">filename_string</span><span class="p">:</span>
                        <span class="n">naxis</span> <span class="o">=</span> <span class="n">filename_string</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;]&#39;</span><span class="p">)[</span>
                            <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;=&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">naxis</span> <span class="o">=</span> <span class="n">filename_string</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;]&#39;</span><span class="p">)[</span>
                            <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">naxis</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">naxis</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;0&quot;</span><span class="p">)</span>
                    <span class="n">naxis</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>  <span class="c"># for astropy.fits row-major ordering</span>
                    <span class="n">naxis</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">naxis</span><span class="p">)</span>
                    <span class="n">naxis</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">axis</span> <span class="o">-</span>
                        <span class="mi">1</span> <span class="k">if</span> <span class="n">axis</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">naxis</span><span class="p">]</span>  <span class="c"># zero index fits</span>
                    <span class="n">naxis</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">naxis</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Problem parsing filename&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">load_header</span><span class="p">:</span>
                <span class="c"># set the extension from the header information returned from DS9</span>
                <span class="c"># this is the best way to get the information if the user changes</span>
                <span class="c"># the loaded file using the gui</span>
                <span class="n">header_cards</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">Header</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">get_header</span><span class="p">(),</span>
                    <span class="n">sep</span><span class="o">=</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                <span class="n">mef_file</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">check_filetype</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">mef_file</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">extver</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">header_cards</span><span class="p">[</span><span class="s">&#39;EXTVER&#39;</span><span class="p">])</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="c"># fits doesn&#39;t require extver if there is only 1</span>
                        <span class="c"># extension</span>
                        <span class="n">extver</span> <span class="o">=</span> <span class="mi">1</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">extname</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">header_cards</span><span class="p">[</span><span class="s">&#39;EXTNAME&#39;</span><span class="p">])</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="n">extname</span> <span class="o">=</span> <span class="bp">None</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">numaxis</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">header_cards</span><span class="p">[</span><span class="s">&#39;NAXIS&#39;</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s">&quot;Problem getting NAXIS from header&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">iscube</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">numaxis</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">iscube</span> <span class="o">=</span> <span class="bp">True</span>
                        <span class="n">naxis</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                        <span class="c"># assume the first axis in each extension is displayed</span>
                        <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numaxis</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                            <span class="n">naxis</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">naxis</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">naxis</span><span class="p">)</span>

            <span class="c"># update the viewer dictionary, if the user changes what&#39;s displayed in a frame this should update correctly</span>
            <span class="c"># this dictionary will be referenced in the other parts of the code. This enables tracking user arrays through</span>
            <span class="c"># frame changes</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="p">[</span><span class="n">frame</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;filename&#39;</span><span class="p">:</span> <span class="n">filename</span><span class="p">,</span>
                                   <span class="s">&#39;extver&#39;</span><span class="p">:</span> <span class="n">extver</span><span class="p">,</span>
                                   <span class="s">&#39;extname&#39;</span><span class="p">:</span> <span class="n">extname</span><span class="p">,</span>
                                   <span class="s">&#39;naxis&#39;</span><span class="p">:</span> <span class="n">naxis</span><span class="p">,</span>
                                   <span class="s">&#39;numaxis&#39;</span><span class="p">:</span> <span class="n">numaxis</span><span class="p">,</span>
                                   <span class="s">&#39;iscube&#39;</span><span class="p">:</span> <span class="n">iscube</span><span class="p">,</span>
                                   <span class="s">&#39;user_array&#39;</span><span class="p">:</span> <span class="n">user_array</span><span class="p">,</span>
                                   <span class="s">&#39;mef&#39;</span><span class="p">:</span> <span class="n">mef_file</span><span class="p">}</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;No frame loaded in viewer&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="ds9.valid_data_in_viewer"><a class="viewcode-back" href="../../api/imexam.ds9_viewer.ds9.html#imexam.ds9_viewer.ds9.valid_data_in_viewer">[docs]</a>    <span class="k">def</span> <span class="nf">valid_data_in_viewer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return bool if valid file or array is loaded into the viewer&quot;&quot;&quot;</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">frame</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_frameinfo</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="p">[</span><span class="n">frame</span><span class="p">][</span><span class="s">&#39;filename&#39;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="bp">True</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="p">[</span><span class="n">frame</span><span class="p">][</span><span class="s">&#39;user_array&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                        <span class="k">return</span> <span class="bp">True</span>
                <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&quot;error in array&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="ds9.get_filename"><a class="viewcode-back" href="../../api/imexam.ds9_viewer.ds9.html#imexam.ds9_viewer.ds9.get_filename">[docs]</a>    <span class="k">def</span> <span class="nf">get_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return the filename currently on display</span>


<span class="sd">        This function will check if there is already a filename saved. It&#39;s possible that the user can</span>
<span class="sd">        connect to a ds9 window with no file loaded and then ask for the data file name after loading one through</span>
<span class="sd">        the ds9 menu options. This will poll the private filename and then try and set one if it&#39;s empty.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># see if the user has loaded a file by hand or changed frames in the</span>
        <span class="c"># gui</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">frame</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_frame</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_frameinfo</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="p">[</span><span class="n">frame</span><span class="p">][</span><span class="s">&#39;filename&#39;</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="ds9.get_frame_info"><a class="viewcode-back" href="../../api/imexam.ds9_viewer.ds9.html#imexam.ds9_viewer.ds9.get_frame_info">[docs]</a>    <span class="k">def</span> <span class="nf">get_frame_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return more explicit information about the data displayed in the current frame&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_frameinfo</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">()]</span>
</div>
<div class="viewcode-block" id="ds9.get_viewer_info"><a class="viewcode-back" href="../../api/imexam.ds9_viewer.ds9.html#imexam.ds9_viewer.ds9.get_viewer_info">[docs]</a>    <span class="k">def</span> <span class="nf">get_viewer_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a dictionary of information about all frames which are loaded with data</span>


<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Consider adding a loop to verify that all the frames still exist and the user</span>
<span class="sd">        has not deleted any through the gui.</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_frameinfo</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span>
</div>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_purge_tmp_dirs</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete temporary directories made for the unix socket</span>

<span class="sd">        When used with ipython (pylab mode), it seems that the objects</span>
<span class="sd">        are not properly deleted, i.e., temporary directories are not</span>
<span class="sd">        deleted. This is a work around for that.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">cls</span><span class="o">.</span><span class="n">_tmp_dir</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">_tmp_dir</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_stop_running_process</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;stop self generated DS9 windows when user quits python window&quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="n">cls</span><span class="o">.</span><span class="n">_process_list</span><span class="p">:</span>
            <span class="n">process</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">_process_list</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">process</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_stop_process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;stop the ds9 window process nicely, only if this package started it&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds9_process</span><span class="p">:</span>
                <span class="c"># none means not yet terminated</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds9_process</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;exit&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds9_process</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_list</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_process_list</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds9_process</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">XpaException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;XPA Exception: {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_purge_local</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;remove temporary directories from the unix socket&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_need_to_purge</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quit_ds9_on_del</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s">&quot;You need to manually delete tmp. dir ({0:s})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_tmpd_name</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_process</span><span class="p">()</span>
        <span class="c"># add a wait for the process to terminate before trying to delete the</span>
        <span class="c"># tree</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tmpd_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s">&quot;Warning : couldn&#39;t delete the temporary directory ({0:s})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tmpd_name</span><span class="p">,))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_need_to_purge</span> <span class="o">=</span> <span class="bp">False</span>

<div class="viewcode-block" id="ds9.close"><a class="viewcode-back" href="../../api/imexam.ds9_viewer.ds9.html#imexam.ds9_viewer.ds9.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; close the window and end connection&quot;&quot;&quot;</span>
        <span class="c"># make sure we clean up the object and quit_ds9 local files</span>
        <span class="k">if</span> <span class="s">&#39;local&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xpa_method</span> <span class="ow">or</span> <span class="s">&#39;tmp&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xpa_method</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_purge_local</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stop_process</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="ds9.run_inet_ds9"><a class="viewcode-back" href="../../api/imexam.ds9_viewer.ds9.html#imexam.ds9_viewer.ds9.run_inet_ds9">[docs]</a>    <span class="k">def</span> <span class="nf">run_inet_ds9</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;start a new ds9 window using an inet socket connection</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        It is given a unique title so it can be identified later.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">env</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span>

        <span class="c"># this is the title of the window, without a nameserver connection</span>
        <span class="c"># is there a way to get the inet x:x address?</span>
        <span class="c"># that should be unique enough, something better?</span>
        <span class="n">xpaname</span> <span class="o">=</span> <span class="s">&quot;imexam&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds9_path</span><span class="p">,</span>
                       <span class="s">&quot;-xpa&quot;</span><span class="p">,</span> <span class="s">&quot;inet&quot;</span><span class="p">,</span>
                       <span class="s">&quot;-title&quot;</span><span class="p">,</span> <span class="n">xpaname</span><span class="p">],</span>
                      <span class="n">shell</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ds9_process</span> <span class="o">=</span> <span class="n">p</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_process_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_need_to_purge</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">return</span> <span class="n">xpaname</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c"># refine error class</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Opening  ds9 failed&quot;</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;Exception: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
            <span class="kn">from</span> <span class="nn">signal</span> <span class="kn">import</span> <span class="n">SIGTERM</span>
            <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">SIGTERM</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span>
</div>
    <span class="k">def</span> <span class="nf">_run_unixonly_ds9</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; start new ds9 window and connect to object using a unix socket</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        When the xpa method in libxpa parses given template as an unix socket, it checks if the template string starts with tmpdir (from env[&quot;XPA_TMPDIR&quot;]</span>
<span class="sd">        or default to /tmp/.xpa). This can make having multiple instances of ds9 a bit difficult, but if you give it unique names or use the inet address</span>
<span class="sd">        you should be fine</span>

<span class="sd">        For unix only, we run ds9 with XPA_TMPDIR set to temporary directory whose prefix start with /tmp/xpa</span>
<span class="sd">        (eg, /tmp/xpa_sf23f), them set os.environ[&quot;XPA_TMPDIR&quot;] (which affect xpa set and/or get command from python) to /tmp/xpa.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span>
        <span class="n">wait_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait_time</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_tmpd_name</span> <span class="o">=</span> <span class="n">mkdtemp</span><span class="p">(</span>
            <span class="n">prefix</span><span class="o">=</span><span class="s">&quot;xpa_&quot;</span> <span class="o">+</span>
            <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s">&quot;USER&quot;</span><span class="p">,</span>
                <span class="s">&quot;&quot;</span><span class="p">),</span>
            <span class="nb">dir</span><span class="o">=</span><span class="s">&quot;/tmp&quot;</span><span class="p">)</span>

        <span class="c"># this is the first directory the servers looks for on the path</span>
        <span class="n">env</span><span class="p">[</span><span class="s">&quot;XPA_TMPDIR&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tmpd_name</span>

        <span class="n">iraf_unix</span> <span class="o">=</span> <span class="s">&quot;{0:s}/.IMT&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tmpd_name</span><span class="p">)</span>
        <span class="c"># that should be unique enough, something better?</span>
        <span class="n">title</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># unix only flag disables the fifos and inet connections</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds9_path</span><span class="p">,</span>
                       <span class="s">&quot;-xpa&quot;</span><span class="p">,</span> <span class="s">&quot;local&quot;</span><span class="p">,</span>
                       <span class="s">&quot;-unix_only&quot;</span><span class="p">,</span> <span class="s">&quot;-title&quot;</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span>
                       <span class="s">&quot;-unix&quot;</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">iraf_unix</span><span class="p">],</span>
                      <span class="n">shell</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">)</span>

            <span class="c"># wait until ds9 starts and the .IMT socket exists</span>
            <span class="k">while</span> <span class="n">wait_time</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">file_list</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tmpd_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="s">&quot;.IMT&quot;</span> <span class="ow">in</span> <span class="n">file_list</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="n">wait_time</span> <span class="o">-=</span> <span class="mf">0.5</span>

            <span class="k">if</span> <span class="n">wait_time</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">signal</span> <span class="kn">import</span> <span class="n">SIGTERM</span>
                <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">SIGTERM</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span>
                    <span class="s">&quot;Connection timeout with the ds9. Try to increase the *wait_time* parameter (current value is  {0:d} s)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait_time</span><span class="p">,))</span>

        <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Starting ds9 failed&quot;</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tmpd_name</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tmp_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tmpd_name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ds9_process</span> <span class="o">=</span> <span class="n">p</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_process_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="c"># this might be sketchy</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">file_list</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s">&quot;.IMT&quot;</span><span class="p">)</span>  <span class="c"># should be in the directory, if not</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">IOError</span><span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;IMT not found in tmp, using first thing in list&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">xpaname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tmpd_name</span><span class="p">,</span> <span class="n">file_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tmpd_name</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Problem starting ds9 local socket connection&quot;</span><span class="p">)</span>

        <span class="n">env</span><span class="p">[</span><span class="s">&quot;XPA_TMPDIR&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;/tmp/xpa&quot;</span>  <span class="c"># for all local connections</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_need_to_purge</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_xpa_method</span> <span class="o">=</span> <span class="s">&#39;local&#39;</span>
        <span class="k">return</span> <span class="n">xpaname</span><span class="p">,</span> <span class="n">iraf_unix</span>

<div class="viewcode-block" id="ds9.set_iraf_display"><a class="viewcode-back" href="../../api/imexam.ds9_viewer.ds9.html#imexam.ds9_viewer.ds9.set_iraf_display">[docs]</a>    <span class="k">def</span> <span class="nf">set_iraf_display</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set the environemnt variable IMTDEV to the socket address of the current imexam.ds9 instance.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        For example, your pyraf commands will use this ds9 for display.</span>

<span class="sd">        TODO: Not sure this is still needed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&quot;IMTDEV&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;unix:</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds9_unix_name</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_check_ds9_process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check to see if the ds9 process is still running</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        If you start a ds9 window from the shell and then connect to imexam, imexam</span>
<span class="sd">        will not have a reference for the process, so this method ignores that state.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds9_process</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds9_process</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">ret</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;The ds9 process is externally killed.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_purge_local</span><span class="p">()</span>

<div class="viewcode-block" id="ds9.set"><a class="viewcode-back" href="../../api/imexam.ds9_viewer.ds9.html#imexam.ds9_viewer.ds9.set">[docs]</a>    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">buf</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;XPA set method to ds9 instance</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This function is linked with the Cython implementation</span>

<span class="sd">        set(param, buf=None)</span>
<span class="sd">        param : parameter string (eg. &quot;fits&quot; &quot;regions&quot;)</span>
<span class="sd">        buf : aux data string (sometime string needed to be ended with CR)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_ds9_process</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xpa</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ds9.get"><a class="viewcode-back" href="../../api/imexam.ds9_viewer.ds9.html#imexam.ds9_viewer.ds9.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;XPA get method to ds9 instance which returns received string</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        param : parameter string (eg. &quot;fits&quot; &quot;regions&quot;)</span>


<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This function is linked with the Cython implementation</span>
<span class="sd">        get(param)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_ds9_process</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">xpa</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ds9.readcursor"><a class="viewcode-back" href="../../api/imexam.ds9_viewer.ds9.html#imexam.ds9_viewer.ds9.readcursor">[docs]</a>    <span class="k">def</span> <span class="nf">readcursor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;returns image coordinate postion and key pressed,</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        XPA returns strings of the form:  u a  257.5 239 \n</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">xpa_string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;imexam any coordinate image&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">XpaException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;Xpa problem reading cursor: {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
            <span class="k">raise</span> <span class="ne">KeyError</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Outside of data range&quot;</span><span class="p">)</span>

        <span class="n">k</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">xpa_string</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

        <span class="c"># ds9 is returning 1 based array</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ds9.alignwcs"><a class="viewcode-back" href="../../api/imexam.ds9_viewer.ds9.html#imexam.ds9_viewer.ds9.alignwcs">[docs]</a>    <span class="k">def</span> <span class="nf">alignwcs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;align wcs</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        on: bool</span>
<span class="sd">            Align the images using the WCS in their headers</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;align </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">on</span><span class="p">)))</span>
</div>
<div class="viewcode-block" id="ds9.blink"><a class="viewcode-back" href="../../api/imexam.ds9_viewer.ds9.html#imexam.ds9_viewer.ds9.blink">[docs]</a>    <span class="k">def</span> <span class="nf">blink</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">blink</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Blink frames</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        blink: bool, optional</span>
<span class="sd">            Set to True to start blinking the frames which are open</span>

<span class="sd">        interval: int</span>
<span class="sd">            Set interval equal to the length of pause for blinking</span>


<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        blink_syntax=</span>
<span class="sd">            Syntax:</span>
<span class="sd">            blink</span>
<span class="sd">            [true|false]</span>
<span class="sd">            [interval &lt;value&gt;]</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cstring</span> <span class="o">=</span> <span class="s">&quot;blink &quot;</span>
        <span class="k">if</span> <span class="n">blink</span><span class="p">:</span>
            <span class="n">cstring</span> <span class="o">+=</span> <span class="s">&quot;yes &quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cstring</span> <span class="o">+=</span> <span class="s">&quot;no &quot;</span>
            <span class="k">if</span> <span class="n">interval</span><span class="p">:</span>
                <span class="n">cstring</span> <span class="o">+=</span> <span class="p">(</span><span class="s">&quot; </span><span class="si">%d</span><span class="s">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">interval</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cstring</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ds9.clear_contour"><a class="viewcode-back" href="../../api/imexam.ds9_viewer.ds9.html#imexam.ds9_viewer.ds9.clear_contour">[docs]</a>    <span class="k">def</span> <span class="nf">clear_contour</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;clear contours from the screen&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;contour clear&quot;</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_define_cmaps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;setup the default color maps which are available&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_cmap_syntax</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">        Syntax:</span>
<span class="s">        cmap [&lt;colormap&gt;]</span>
<span class="s">            [file]</span>
<span class="s">            [load &lt;filename&gt;]</span>
<span class="s">            [save &lt;filename&gt;]</span>
<span class="s">            [invert true|false]</span>
<span class="s">            [value &lt;constrast&gt; &lt;bias&gt;]</span>
<span class="s">            [tag [load|save] &lt;filename&gt;]</span>
<span class="s">            [tag delete]</span>
<span class="s">            [match]</span>
<span class="s">            [lock [true|false]]</span>
<span class="s">            [open|close]</span>

<span class="s">         Example:</span>
<span class="s">            &gt;obj.cmap(map=&quot;Heat&quot;)</span>
<span class="s">            &gt;obj.cmap(invert=True)</span>
<span class="s">         &quot;&quot;&quot;</span>

        <span class="c"># is there a list I can pull automatically from ds9?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cmap_colors</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s">&quot;heat&quot;</span><span class="p">,</span>
            <span class="s">&quot;grey&quot;</span><span class="p">,</span>
            <span class="s">&quot;cool&quot;</span><span class="p">,</span>
            <span class="s">&quot;aips0&quot;</span><span class="p">,</span>
            <span class="s">&quot;a&quot;</span><span class="p">,</span>
            <span class="s">&quot;b&quot;</span><span class="p">,</span>
            <span class="s">&quot;bb&quot;</span><span class="p">,</span>
            <span class="s">&quot;he&quot;</span><span class="p">,</span>
            <span class="s">&quot;i8&quot;</span><span class="p">]</span>

<div class="viewcode-block" id="ds9.cmap"><a class="viewcode-back" href="../../api/imexam.ds9_viewer.ds9.html#imexam.ds9_viewer.ds9.cmap">[docs]</a>    <span class="k">def</span> <span class="nf">cmap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">load</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">invert</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
             <span class="n">filename</span><span class="o">=</span><span class="s">&#39;colormap.ds9&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set the color map table to something else, using a defined list of options</span>


<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        color: string</span>
<span class="sd">            color must be set to one of the available DS9 color map names</span>

<span class="sd">        load: string, optional</span>
<span class="sd">            set to the filename which is a valid colormap lookup table</span>
<span class="sd">            valid contrast values are from 0 to 10, and valid bias values are from 0 to 1</span>

<span class="sd">        invert: bool, optional</span>
<span class="sd">            invert the colormap</span>

<span class="sd">        save: bool, optional</span>
<span class="sd">            save the current colormap as a file</span>

<span class="sd">        filename: string, optional</span>
<span class="sd">            the name of the file to save the colormap to</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">color</span><span class="p">:</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">color</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">color</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cmap_colors</span><span class="p">:</span>
                <span class="n">cstring</span> <span class="o">=</span> <span class="s">&quot;cmap </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">color</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cstring</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;Unrecognized color map, choose one of these:&quot;</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cmap_colors</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">invert</span><span class="p">:</span>
            <span class="n">invert</span> <span class="o">=</span> <span class="s">&#39;yes&#39;</span>
            <span class="n">cstring</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;cmap invert </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">invert</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cstring</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">load</span><span class="p">:</span>
            <span class="n">cstring</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;cmap load </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">load</span><span class="p">)</span>  <span class="c"># where load is the filename</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cstring</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">cstring</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;cmap save </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cstring</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ds9.colorbar"><a class="viewcode-back" href="../../api/imexam.ds9_viewer.ds9.html#imexam.ds9_viewer.ds9.colorbar">[docs]</a>    <span class="k">def</span> <span class="nf">colorbar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;turn the colorbar on the bottom of the window on and off</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        on: bool</span>
<span class="sd">            Set to True to turn on the colorbar, False to turn it off</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;colorbar </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">on</span><span class="p">)))</span>
</div>
<div class="viewcode-block" id="ds9.contour"><a class="viewcode-back" href="../../api/imexam.ds9_viewer.ds9.html#imexam.ds9_viewer.ds9.contour">[docs]</a>    <span class="k">def</span> <span class="nf">contour</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">construct</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;show contours on the window</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        on: bool</span>
<span class="sd">            Set to true to turn on contours</span>

<span class="sd">        construct: bool, optional</span>
<span class="sd">            Will open the contour dialog box which has more options</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;contour {0:s}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">on</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">construct</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;contour levels&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ds9.contour_load"><a class="viewcode-back" href="../../api/imexam.ds9_viewer.ds9.html#imexam.ds9_viewer.ds9.contour_load">[docs]</a>    <span class="k">def</span> <span class="nf">contour_load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;load a contour file into the window</span>


<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename: string</span>
<span class="sd">            The name of the file with the contour level defined</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filename</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;contour loadlevels {0:s}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">filename</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;No filename provided for contours&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ds9.crosshair"><a class="viewcode-back" href="../../api/imexam.ds9_viewer.ds9.html#imexam.ds9_viewer.ds9.crosshair">[docs]</a>    <span class="k">def</span> <span class="nf">crosshair</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">coordsys</span><span class="o">=</span><span class="s">&quot;physical&quot;</span><span class="p">,</span>
                  <span class="n">skyframe</span><span class="o">=</span><span class="s">&quot;wcs&quot;</span><span class="p">,</span> <span class="n">skyformat</span><span class="o">=</span><span class="s">&quot;fk5&quot;</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">lock</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Control the position of the crosshair in the current frame, crosshair mode is turned on automatically</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        x: string or int</span>
<span class="sd">            The value of x is converted to a string for the call to XPA, use a value here appropriate for the skyformat you choose</span>

<span class="sd">        y: string or int</span>
<span class="sd">            The value of y is converted to a string for the call to XPA, use a value here appropriate for the skyformat you choose</span>

<span class="sd">        coordsys: string, optional</span>
<span class="sd">            The coordinate system your x and y are defined in</span>

<span class="sd">        skyframe: string, optional</span>
<span class="sd">            If skyframe has &quot;wcs&quot; in it then skyformat is also sent to the XPA</span>

<span class="sd">        skyformat: string, optional</span>
<span class="sd">            Used with skyframe, specifies the format of the coordinate which were given in x and y</span>

<span class="sd">        match: bool, optional</span>
<span class="sd">            If set to True, then the wcs is matched for the frames</span>

<span class="sd">        lock: bool, optional</span>
<span class="sd">            If set to True, then the frame is locked in wcs</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">and</span> <span class="n">y</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&quot;wcs&quot;</span> <span class="ow">in</span> <span class="n">skyframe</span><span class="p">:</span>
                <span class="n">format</span> <span class="o">=</span> <span class="n">skyformat</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">format</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;crosshair {0:s} {1:s} {2:s} {3:s}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">coordsys</span><span class="p">),</span> <span class="n">format</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;crosshair match wcs&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;crosshair lock wcs&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ds9.cursor"><a class="viewcode-back" href="../../api/imexam.ds9_viewer.ds9.html#imexam.ds9_viewer.ds9.cursor">[docs]</a>    <span class="k">def</span> <span class="nf">cursor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;move the cursor in the current frame to the specified image pixel; selected regions will also be moved</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x: int</span>
<span class="sd">            pixel location  x coordinate to move to</span>

<span class="sd">        y: int</span>
<span class="sd">            pixel location  y coordinate to move to</span>

<span class="sd">        x and y are converted to strings for the call</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">and</span> <span class="n">y</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;cursor {0:s} {1:s}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">y</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s">&quot;You need to supply both an x and y location for the cursor&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ds9.disp_header"><a class="viewcode-back" href="../../api/imexam.ds9_viewer.ds9.html#imexam.ds9_viewer.ds9.disp_header">[docs]</a>    <span class="k">def</span> <span class="nf">disp_header</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Display the header of the current image to a DS9 window&quot;&quot;&quot;</span>

        <span class="n">cstring</span> <span class="o">=</span> <span class="s">&quot;header &quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cstring</span><span class="p">)</span>  <span class="c"># display the header of the current frame</span>
        <span class="k">except</span> <span class="n">XpaException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">XpaException</span><span class="p">(</span><span class="s">&quot;XPA Exception getting header: {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="ds9.frame"><a class="viewcode-back" href="../../api/imexam.ds9_viewer.ds9.html#imexam.ds9_viewer.ds9.frame">[docs]</a>    <span class="k">def</span> <span class="nf">frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;convenience function to change or report frames</span>


<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        n: int, string, optional</span>
<span class="sd">            The frame number to open or change to. If the number specified doesn&#39;t exist, a new frame will be opened</span>
<span class="sd">            If nothing is specified, then the current frame number will be returned. The value of n is converted to</span>
<span class="sd">            a string before passing to the XPA</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        frame(1)  sets the current frame to 1</span>
<span class="sd">        frame(&quot;last&quot;) set the current frame to the last frame</span>
<span class="sd">        frame() returns the number of the current frame</span>
<span class="sd">        frame(&quot;new&quot;) opens a new frame</span>
<span class="sd">        frame(3)  opens frame 3 if it doesn&#39;t exist already, otherwise goes to frame 3</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;frame&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>  <span class="c"># xpa returns &#39;\n&#39; for no frame</span>

        <span class="k">if</span> <span class="n">frame</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">n</span><span class="p">:</span>
                <span class="k">if</span> <span class="s">&quot;delete&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">frame</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="p">:</span>
                        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="p">[</span><span class="n">frame</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;frame {0:s}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;frame 1&quot;</span><span class="p">)</span>
                        <span class="c"># the user can delete frame 1, but ds9 defaults to 1,</span>
                        <span class="c"># so set it</span>
                        <span class="k">return</span> <span class="s">&#39;1&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">XpaException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">XpaException</span><span class="p">(</span>
                        <span class="s">&quot;XPA Exception getting frame: {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;frame 1&quot;</span><span class="p">)</span>
                <span class="c"># the user can delete frame 1, but ds9 defaults to 1, so set it</span>
                <span class="k">return</span> <span class="s">&#39;1&#39;</span>
</div>
<div class="viewcode-block" id="ds9.iscube"><a class="viewcode-back" href="../../api/imexam.ds9_viewer.ds9.html#imexam.ds9_viewer.ds9.iscube">[docs]</a>    <span class="k">def</span> <span class="nf">iscube</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return information on whether a cube image is displayed in the current frame&quot;&quot;&quot;</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">frame</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_frame</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_frameinfo</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="p">[</span><span class="n">frame</span><span class="p">][</span><span class="s">&#39;iscube&#39;</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="ds9.get_slice_info"><a class="viewcode-back" href="../../api/imexam.ds9_viewer.ds9.html#imexam.ds9_viewer.ds9.get_slice_info">[docs]</a>    <span class="k">def</span> <span class="nf">get_slice_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return the slice tuple that is currently displayed&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_frameinfo</span><span class="p">()</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="p">[</span><span class="n">frame</span><span class="p">][</span><span class="s">&#39;iscube&#39;</span><span class="p">]:</span>
            <span class="n">image_slice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="p">[</span><span class="n">frame</span><span class="p">][</span><span class="s">&#39;naxis&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">image_slice</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">image_slice</span>
</div>
<div class="viewcode-block" id="ds9.get_data"><a class="viewcode-back" href="../../api/imexam.ds9_viewer.ds9.html#imexam.ds9_viewer.ds9.get_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; return a numpy array of the data displayed in the current frame</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This is the data array that the imexam() function from connect() uses for analysis</span>

<span class="sd">        astropy.io.fits stores data in row-major format. So a 4d image would be  [NAXIS4, NAXIS3, NAXIS2, NAXIS1]</span>
<span class="sd">        just the one image is retured in the case of multidimensional data, not the cube</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># make sure the filename and extension info are correct for the current</span>
        <span class="c"># frame in DS9, users can change this in the gui</span>
        <span class="c"># users can change frame and slice before calling this, best to check</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_frameinfo</span><span class="p">()</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">frame</span><span class="p">:</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="p">[</span><span class="n">frame</span><span class="p">][</span><span class="s">&#39;user_array&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="p">[</span><span class="n">frame</span><span class="p">][</span><span class="s">&#39;user_array&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="p">[</span><span class="n">frame</span><span class="p">][</span><span class="s">&#39;filename&#39;</span><span class="p">]</span>
                <span class="n">extver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="p">[</span><span class="n">frame</span><span class="p">][</span><span class="s">&#39;extver&#39;</span><span class="p">]</span>
                <span class="n">extname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="p">[</span><span class="n">frame</span><span class="p">][</span><span class="s">&#39;extname&#39;</span><span class="p">]</span>
                <span class="n">naxis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="p">[</span><span class="n">frame</span><span class="p">][</span><span class="s">&#39;naxis&#39;</span><span class="p">]</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="p">[</span><span class="n">frame</span><span class="p">][</span><span class="s">&#39;mef&#39;</span><span class="p">]:</span>
                    <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">filedata</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="p">[</span><span class="n">frame</span><span class="p">][</span><span class="s">&#39;iscube&#39;</span><span class="p">]:</span>
                            <span class="n">data</span> <span class="o">=</span> <span class="n">filedata</span><span class="p">[</span><span class="n">extname</span><span class="p">,</span> <span class="n">extver</span><span class="p">]</span><span class="o">.</span><span class="n">section</span><span class="p">[</span><span class="n">naxis</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">data</span> <span class="o">=</span> <span class="n">filedata</span><span class="p">[</span><span class="n">extname</span><span class="p">,</span> <span class="n">extver</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
                    <span class="k">return</span> <span class="n">data</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">filedata</span><span class="p">:</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">filedata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
                    <span class="k">return</span> <span class="n">data</span>
</div>
<div class="viewcode-block" id="ds9.get_header"><a class="viewcode-back" href="../../api/imexam.ds9_viewer.ds9.html#imexam.ds9_viewer.ds9.get_header">[docs]</a>    <span class="k">def</span> <span class="nf">get_header</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return the current fits header as a string or None if there&#39;s a problem&quot;&quot;&quot;</span>

        <span class="c"># TODO return the simple header for arrays which are loaded</span>

        <span class="n">frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">frame</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_frame</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_frameinfo</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="p">[</span><span class="n">frame</span><span class="p">][</span><span class="s">&#39;filename&#39;</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;fits header&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">XpaException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;XPA Exception getting header: {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="k">return</span> <span class="bp">None</span>

            <span class="k">return</span> <span class="n">header</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;No file with header loaded into ds9&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="ds9.grid"><a class="viewcode-back" href="../../api/imexam.ds9_viewer.ds9.html#imexam.ds9_viewer.ds9.grid">[docs]</a>    <span class="k">def</span> <span class="nf">grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">param</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;convenience to turn the grid on and off, grid can be flushed with many more options</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        on: bool, optional</span>
<span class="sd">            Will turn the grid overlay on in the current frame</span>

<span class="sd">        param: bool, optional</span>
<span class="sd">            Will open the parameter dialog in DS9</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;grid </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">on</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">param</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;grid open&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ds9.hideme"><a class="viewcode-back" href="../../api/imexam.ds9_viewer.ds9.html#imexam.ds9_viewer.ds9.hideme">[docs]</a>    <span class="k">def</span> <span class="nf">hideme</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;lower the ds9 window&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;lower&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ds9.load_fits"><a class="viewcode-back" href="../../api/imexam.ds9_viewer.ds9.html#imexam.ds9_viewer.ds9.load_fits">[docs]</a>    <span class="k">def</span> <span class="nf">load_fits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">extver</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">extname</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;convenience function to load fits image to current frame</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fname: string, optional</span>
<span class="sd">            The name of the file to be loaded. You can specify the full extension in the name, such as</span>
<span class="sd">            filename_flt.fits[sci,1] or filename_flt.fits[1]</span>

<span class="sd">        extver: int, optional</span>
<span class="sd">            The extension to load (EXTVER in the header)</span>

<span class="sd">        extname: string, optional</span>
<span class="sd">            The name (EXTNAME in the header) of the image to load</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        To tell ds9 to open a file whose name or path includes spaces,</span>
<span class="sd">        surround the path with &quot;{...}&quot;, e.g.</span>

<span class="sd">        % xpaset -p ds9 file &quot;{foo bar/my image.fits}&quot;</span>

<span class="sd">        This is assuming that the image loads into the current or next new frame, watch the internal</span>
<span class="sd">        file and ext values because the user can switch frames through DS9 app itself</span>

<span class="sd">        XPA needs to have the absolute path to the filename so that if the DS9 window was started</span>
<span class="sd">        in another directory it can still find the file to load. arg.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">frame</span><span class="p">:</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c"># load into first frame</span>

        <span class="k">if</span> <span class="n">fname</span><span class="p">:</span>
            <span class="c"># see if the image is MEF or Simple</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

            <span class="c"># strip the extensions for now</span>
            <span class="n">shortname</span> <span class="o">=</span> <span class="n">fname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;[&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">cstring</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">verify_filename</span><span class="p">(</span><span class="n">shortname</span><span class="p">,</span> <span class="n">extver</span><span class="p">,</span> <span class="n">extname</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cstring</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_frameinfo</span><span class="p">()</span>
            <span class="c"># make sure any previous reference is reset</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="p">[</span><span class="n">frame</span><span class="p">][</span><span class="s">&#39;user_array&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;No filename provided&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ds9.load_region"><a class="viewcode-back" href="../../api/imexam.ds9_viewer.ds9.html#imexam.ds9_viewer.ds9.load_region">[docs]</a>    <span class="k">def</span> <span class="nf">load_region</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load regions from a file which uses ds9 standard formatting</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        filename: string</span>
<span class="sd">            The file containing the DS9 style region description</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">F_OK</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;regions load </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;No such file:{0:s}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="ds9.load_rgb"><a class="viewcode-back" href="../../api/imexam.ds9_viewer.ds9.html#imexam.ds9_viewer.ds9.load_rgb">[docs]</a>    <span class="k">def</span> <span class="nf">load_rgb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">red</span><span class="p">,</span> <span class="n">green</span><span class="p">,</span> <span class="n">blue</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">lockwcs</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;load 3 images into an RGBimage frame</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        red: string</span>
<span class="sd">            The name of the fits file which will be loaded into the red channel</span>

<span class="sd">        green: string</span>
<span class="sd">            The name of the fits file which will be loaded into the green channel</span>

<span class="sd">        blue: string</span>
<span class="sd">            The name of the fits file which will be loaded into the blue channel</span>

<span class="sd">        scale: bool</span>
<span class="sd">            If True, then each image will be scale with zscale() after loading</span>

<span class="sd">        lockwcs: bool</span>
<span class="sd">            If True, then the image positions will be locked to each other using the WCS</span>
<span class="sd">            information in their headers</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;rgb new&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;rgb channel red&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_fits</span><span class="p">(</span><span class="n">red</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scale</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;rgb channel green&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_fits</span><span class="p">(</span><span class="n">green</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scale</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;rgb channel blue&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_fits</span><span class="p">(</span><span class="n">blue</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scale</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">lockwcs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;rgb wcs yes&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ds9.load_mef_as_cube"><a class="viewcode-back" href="../../api/imexam.ds9_viewer.ds9.html#imexam.ds9_viewer.ds9.load_mef_as_cube">[docs]</a>    <span class="k">def</span> <span class="nf">load_mef_as_cube</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load a Mult-Extension-Fits image into one frame as an image cube&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;No filename specified&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;file mecube new {0:s}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="ds9.load_mef_as_multi"><a class="viewcode-back" href="../../api/imexam.ds9_viewer.ds9.html#imexam.ds9_viewer.ds9.load_mef_as_multi">[docs]</a>    <span class="k">def</span> <span class="nf">load_mef_as_multi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load a Mult-Extension-Fits image into multiple frames&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;No filename specified&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;file multiframe {0:s}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="ds9.mark_region_from_array"><a class="viewcode-back" href="../../api/imexam.ds9_viewer.ds9.html#imexam.ds9_viewer.ds9.mark_region_from_array">[docs]</a>    <span class="k">def</span> <span class="nf">mark_region_from_array</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">input_points</span><span class="p">,</span> <span class="n">ptype</span><span class="o">=</span><span class="s">&quot;image&quot;</span><span class="p">,</span> <span class="n">textoff</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;mark ds9 regions regions  given an input list of tuples, a convienence function, you can also use set_region</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        input_points: a tuple, or list of tuples, or a string: (x,y,comment),</span>


<span class="sd">        ptype: string</span>
<span class="sd">            the reference system for the point locations, image|physical|fk5</span>

<span class="sd">        size: int</span>
<span class="sd">            the size of the region marker</span>

<span class="sd">        textoff: string</span>
<span class="sd">            the offset for the comment text, if comment is empty it will not show</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        only circular regions are supported currently</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_points</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">input_points</span> <span class="o">=</span> <span class="p">[</span><span class="n">input_points</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_points</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">input_points</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">input_points</span><span class="o">.</span><span class="n">split</span><span class="p">())]</span>

        <span class="n">X</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">COMMENT</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">rtype</span> <span class="o">=</span> <span class="s">&quot;circle&quot;</span>  <span class="c"># only one supported right now</span>

        <span class="k">for</span> <span class="n">location</span> <span class="ow">in</span> <span class="n">input_points</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">rtype</span> <span class="o">==</span> <span class="s">&quot;circle&quot;</span><span class="p">:</span>
                <span class="n">pline</span> <span class="o">=</span> <span class="n">rtype</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> \
                    <span class="nb">str</span><span class="p">(</span><span class="n">location</span><span class="p">[</span><span class="n">X</span><span class="p">])</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">location</span><span class="p">[</span><span class="n">Y</span><span class="p">])</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="n">pline</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_region</span><span class="p">(</span><span class="n">pline</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">location</span><span class="p">[</span><span class="n">COMMENT</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">pline</span> <span class="o">=</span> <span class="s">&quot;text &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">location</span><span class="p">[</span><span class="n">X</span><span class="p">])</span> <span class="o">+</span> <span class="n">textoff</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> \
                        <span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">location</span><span class="p">[</span><span class="n">Y</span><span class="p">])</span> <span class="o">+</span> <span class="n">textoff</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; &#39;&quot;</span> <span class="o">+</span> \
                        <span class="nb">str</span><span class="p">(</span><span class="n">location</span><span class="p">[</span><span class="n">COMMENT</span><span class="p">])</span> <span class="o">+</span> <span class="s">&quot;&#39; #font=times&quot;</span>
                    <span class="k">print</span><span class="p">(</span><span class="n">pline</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_region</span><span class="p">(</span><span class="n">pline</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">pass</span>
</div>
<div class="viewcode-block" id="ds9.make_region"><a class="viewcode-back" href="../../api/imexam.ds9_viewer.ds9.html#imexam.ds9_viewer.ds9.make_region">[docs]</a>    <span class="k">def</span> <span class="nf">make_region</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">infile</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">textoff</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;make an input reg file with  [x,y,comment] to a DS9 reg file, the input file should contains lines with x,y,comment</span>


<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        infile: str</span>
<span class="sd">            input filename</span>

<span class="sd">        labels: bool</span>
<span class="sd">            add labels to the regions</span>

<span class="sd">        header: int</span>
<span class="sd">            number of header lines in text file to skip</span>

<span class="sd">        textoff: int</span>
<span class="sd">            offset in pixels for labels</span>

<span class="sd">        size: int</span>
<span class="sd">            size of the region type</span>


<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        only circular regions are supported currently</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Unable to open input file&quot;</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;{0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>

        <span class="c"># assumed defaults for simple regions file</span>
        <span class="n">point</span> <span class="o">=</span> <span class="n">rtype</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">textoff</span>  <span class="c"># pixels to offset text</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">header</span><span class="p">:]</span>

        <span class="n">numCols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">text</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">x</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">y</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">words</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
            <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="n">y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">labels</span><span class="p">):</span>
                <span class="n">text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

        <span class="c"># now write out to a reg file</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">infile</span> <span class="o">+</span> <span class="s">&quot;.reg&quot;</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">pline</span> <span class="o">=</span> <span class="s">&quot;image; &quot;</span> <span class="o">+</span> <span class="n">point</span> <span class="o">+</span> \
                <span class="s">&quot;(&quot;</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span> <span class="o">+</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;)</span><span class="se">\n</span><span class="s">&quot;</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pline</span><span class="p">)</span>
            <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">pline</span> <span class="o">=</span> <span class="s">&quot;image;text(&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="n">delta</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span> <span class="o">+</span> \
                    <span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="n">delta</span><span class="p">)</span> <span class="o">+</span> \
                    <span class="s">&quot;{ &quot;</span> <span class="o">+</span> <span class="n">text</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot; })# font=</span><span class="se">\&quot;</span><span class="s">time 12 bold</span><span class="se">\&quot;\n</span><span class="s">&quot;</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pline</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">print</span><span class="p">(</span><span class="s">&quot;output reg file saved to: {0:s}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="ds9.match"><a class="viewcode-back" href="../../api/imexam.ds9_viewer.ds9.html#imexam.ds9_viewer.ds9.match">[docs]</a>    <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordsys</span><span class="o">=</span><span class="s">&quot;wcs&quot;</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">crop</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">fslice</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
              <span class="n">scale</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="nb">bin</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">colorbar</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">smooth</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">crosshair</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;match all other frames to the current frame</span>


<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        coordsys: string, optional</span>
<span class="sd">            The coordinate system to use</span>

<span class="sd">        frame: bool, optional</span>
<span class="sd">            Match all other frames to the current frame, using the set coordsys</span>

<span class="sd">        crop: bool, optional</span>
<span class="sd">            Set the current image display area, using the set coordsys</span>

<span class="sd">        fslice: bool, optional</span>
<span class="sd">            Match current slice in all frames</span>

<span class="sd">        scale: bool, optional</span>
<span class="sd">            Match to the current scale for all frames</span>

<span class="sd">        bin: bool, optional</span>
<span class="sd">            Match to the current binning for all frames</span>

<span class="sd">        colorbar: bool, optional</span>
<span class="sd">            Match to the current colorbar for all frames</span>

<span class="sd">        smooth: bool, optional</span>
<span class="sd">            Match to the current smoothing for all frames</span>

<span class="sd">        crosshair: bool, optional</span>
<span class="sd">            Match the crosshair in all frames, using the current coordsys</span>


<span class="sd">        Notes</span>
<span class="sd">        -----</span>

<span class="sd">        You can only choose one of the options at a time, and the logic will select the first True option</span>
<span class="sd">        so set frame=False and something else in addition to your choice if you don&#39;t want the default option.</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cstring</span> <span class="o">=</span> <span class="s">&quot;match &quot;</span>
        <span class="k">if</span> <span class="n">frame</span><span class="p">:</span>
            <span class="n">cstring</span> <span class="o">+=</span> <span class="s">&quot;frame {0:s}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">corrdsys</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">crosshair</span><span class="p">:</span>
            <span class="n">cstring</span> <span class="o">+=</span> <span class="s">&quot;crosshair {0:s}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">corrdsys</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">crop</span><span class="p">:</span>
            <span class="n">cstring</span> <span class="o">+=</span> <span class="s">&quot;crop {0:s}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">corrdsys</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">fslice</span><span class="p">:</span>
            <span class="n">cstring</span> <span class="o">+=</span> <span class="s">&quot;slice&quot;</span>
        <span class="k">elif</span> <span class="nb">bin</span><span class="p">:</span>
            <span class="n">cstring</span> <span class="o">+=</span> <span class="s">&quot;bin&quot;</span>
        <span class="k">elif</span> <span class="n">scale</span><span class="p">:</span>
            <span class="n">cstring</span> <span class="o">+=</span> <span class="s">&quot;scale&quot;</span>
        <span class="k">elif</span> <span class="n">colorbar</span><span class="p">:</span>
            <span class="n">cstring</span> <span class="o">+=</span> <span class="s">&quot;colorbar&quot;</span>
        <span class="k">elif</span> <span class="n">smooth</span><span class="p">:</span>
            <span class="n">cstring</span> <span class="o">+=</span> <span class="s">&quot;smooth&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cstring</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ds9.nancolor"><a class="viewcode-back" href="../../api/imexam.ds9_viewer.ds9.html#imexam.ds9_viewer.ds9.nancolor">[docs]</a>    <span class="k">def</span> <span class="nf">nancolor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&quot;red&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;set the not-a-number color, default is red</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        color: string</span>
<span class="sd">            The color to use for NAN pixels</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;nan {0:s}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">color</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="ds9.panto_image"><a class="viewcode-back" href="../../api/imexam.ds9_viewer.ds9.html#imexam.ds9_viewer.ds9.panto_image">[docs]</a>    <span class="k">def</span> <span class="nf">panto_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;convenience function to change to x,y  physical image coordinates</span>


<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x: float</span>
<span class="sd">            X location in physical coords to pan to</span>

<span class="sd">        y: float</span>
<span class="sd">            Y location in physical coords to pan to</span>


<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;pan to {0:f} {0:f} image&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="ds9.panto_wcs"><a class="viewcode-back" href="../../api/imexam.ds9_viewer.ds9.html#imexam.ds9_viewer.ds9.panto_wcs">[docs]</a>    <span class="k">def</span> <span class="nf">panto_wcs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">system</span><span class="o">=</span><span class="s">&#39;fk5&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;pan to wcs location coordinates in image</span>


<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        x: string</span>
<span class="sd">            The x location to move to, specified using the given system</span>
<span class="sd">        y: string</span>
<span class="sd">            The y location to move to</span>
<span class="sd">        system: string</span>
<span class="sd">            The reference system that x and y were specified in, they should be understood by DS9</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;pan to {0:s} {1:s} wcs </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">system</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="ds9.rotate"><a class="viewcode-back" href="../../api/imexam.ds9_viewer.ds9.html#imexam.ds9_viewer.ds9.rotate">[docs]</a>    <span class="k">def</span> <span class="nf">rotate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;rotate the current frame (in degrees), the current rotation is printed with no params</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        value: float [degrees]</span>
<span class="sd">            Rotate the current frame {value} degrees</span>
<span class="sd">            If value is 0, then the current rotation is printed</span>

<span class="sd">        to: bool</span>
<span class="sd">            Rotate the current frame to the specified value</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;Image rotated at {0:s}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;rotate&quot;</span><span class="p">)))</span>

        <span class="k">elif</span> <span class="n">to</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">cstring</span> <span class="o">=</span> <span class="s">&quot;rotate to {0:s}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cstring</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">cstring</span> <span class="o">=</span> <span class="s">&quot;rotate {0:s}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cstring</span><span class="p">)</span>
        <span class="n">cstring</span> <span class="o">=</span> <span class="s">&quot;Image rotated at {0:s}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;rotate&quot;</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="n">cstring</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">cstring</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ds9.save_regions"><a class="viewcode-back" href="../../api/imexam.ds9_viewer.ds9.html#imexam.ds9_viewer.ds9.save_regions">[docs]</a>    <span class="k">def</span> <span class="nf">save_regions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;save the regions in the current window to a DS9 style regions file</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        filename: string</span>
<span class="sd">            The nameof th file to which the regions displayed in the current window are saved</span>
<span class="sd">            If no filename is provided then it will try and save the regions to the name of the</span>
<span class="sd">            file in the current display with _regions.txt appended</span>

<span class="sd">            If a file of that name already exists on disk it will no attempt to overwrite it</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">regions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;regions save&quot;</span><span class="p">)</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">frame</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="p">[</span><span class="n">frame</span><span class="p">][</span><span class="s">&#39;filename&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;_regions.txt&quot;</span>

        <span class="c"># check if the file already exists</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">F_OK</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">region_file</span><span class="p">:</span>
                <span class="n">region_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">regions</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s">&quot;File already exists: {0} try again&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="ds9.save_rgb"><a class="viewcode-back" href="../../api/imexam.ds9_viewer.ds9.html#imexam.ds9_viewer.ds9.save_rgb">[docs]</a>    <span class="k">def</span> <span class="nf">save_rgb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;save an rgbimage frame as an MEF fits file</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        filename: string</span>
<span class="sd">            The name of the output fits image</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;No filename specified, try again&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;save rgbimage {0:s}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="ds9.scale"><a class="viewcode-back" href="../../api/imexam.ds9_viewer.ds9.html#imexam.ds9_viewer.ds9.scale">[docs]</a>    <span class="k">def</span> <span class="nf">scale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s">&#39;zscale&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The default zscale is the most widely used option</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        scale: string</span>
<span class="sd">            The scale for ds9 to use, these are set strings of</span>
<span class="sd">            [linear|log|pow|sqrt|squared|asinh|sinh|histequ]</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        The xpa doesn&#39;t return an error if you set an unknown scale,</span>
<span class="sd">        it just doesn&#39;t do anything, this is true for all the xpa calls</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">_help</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;Syntax:</span>
<span class="s">           scales available: [linear|log|pow|sqrt|squared|asinh|sinh|histequ]</span>

<span class="s">          [log exp &lt;value&gt;]</span>
<span class="s">          [datasec yes|no]</span>
<span class="s">          [limits &lt;minvalue&gt; &lt;maxvalue&gt;]</span>
<span class="s">          [mode minmax|&lt;value&gt;|zscale|zmax]</span>
<span class="s">          [scope local|global]</span>
<span class="s">          [match]</span>
<span class="s">          [lock [yes|no]]</span>
<span class="s">          [open|close]</span>

<span class="s">          &quot;&quot;&quot;</span>
        <span class="n">mode_scale</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;zscale&quot;</span><span class="p">,</span> <span class="s">&quot;zmax&quot;</span><span class="p">,</span> <span class="s">&quot;minmax&quot;</span><span class="p">]</span>
        <span class="n">cstring</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;scale </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">scale</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">scale</span> <span class="ow">in</span> <span class="n">mode_scale</span><span class="p">:</span>
            <span class="n">cstring</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;scale mode </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">scale</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cstring</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">XpaException</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;{0:s} not valid&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cstring</span><span class="p">))</span>
            <span class="k">print</span><span class="p">(</span><span class="n">_help</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ds9.set_region"><a class="viewcode-back" href="../../api/imexam.ds9_viewer.ds9.html#imexam.ds9_viewer.ds9.set_region">[docs]</a>    <span class="k">def</span> <span class="nf">set_region</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">region_string</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;display a region using the specifications in region_string</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        region_string: string</span>
<span class="sd">            Should take the form of a region string that DS9 is expecting</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        set_region(&quot;physical ruler 200 300 200 400&quot;)</span>
<span class="sd">        set_region(&quot;line 0 400 3 400 #color=red&quot;)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">command</span> <span class="o">=</span> <span class="s">&quot;regions command {{ {0:s} }}</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">region_string</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ds9.showme"><a class="viewcode-back" href="../../api/imexam.ds9_viewer.ds9.html#imexam.ds9_viewer.ds9.showme">[docs]</a>    <span class="k">def</span> <span class="nf">showme</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;raise the ds9 window&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;raise&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ds9.showpix"><a class="viewcode-back" href="../../api/imexam.ds9_viewer.ds9.html#imexam.ds9_viewer.ds9.showpix">[docs]</a>    <span class="k">def</span> <span class="nf">showpix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">close</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;display the pixel value table, close window when done</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        close: bool, optional</span>
<span class="sd">            If set to True, then the pixel table dialog window is closed</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;pixeltable&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">close</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;pixeltable close&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ds9.snapsave"><a class="viewcode-back" href="../../api/imexam.ds9_viewer.ds9.html#imexam.ds9_viewer.ds9.snapsave">[docs]</a>    <span class="k">def</span> <span class="nf">snapsave</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;create a snap shot of the current window and save in specified format.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">       filename: str, optional</span>
<span class="sd">           filename of output image, the extension in the filename can also be used to specify the format</span>
<span class="sd">           If no filename is specified, then the filename will be constructed from the name of the</span>
<span class="sd">           currently displayed image with _snap.jpg appended.</span>

<span class="sd">       format: str, optional</span>
<span class="sd">           available formats are fits, eps, gif, tiff, jpeg, png</span>
<span class="sd">           If no format is specified the filename extension is used</span>

<span class="sd">       resolution: int, optional</span>
<span class="sd">           1 to 100, for jpeg images</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="p">[</span><span class="n">frame</span><span class="p">][</span><span class="s">&#39;filename&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;_snap.jpg&quot;</span>

        <span class="n">cstring</span> <span class="o">=</span> <span class="s">&quot;saveimage &quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="k">if</span> <span class="n">format</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="n">format</span>
        <span class="n">cstring</span> <span class="o">+=</span> <span class="n">name</span>
        <span class="k">if</span> <span class="s">&quot;jpeg&quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">cstring</span> <span class="o">+=</span> <span class="p">(</span><span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">resolution</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cstring</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Image saved to {0:s}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Image saved to {0:s}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="ds9.view"><a class="viewcode-back" href="../../api/imexam.ds9_viewer.ds9.html#imexam.ds9_viewer.ds9.view">[docs]</a>    <span class="k">def</span> <span class="nf">view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Display numpy image array to current frame</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        img: numpy array</span>
<span class="sd">            The array containing data, it will be forced to numpy.array()</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">frame</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;No valid frame&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">bool8</span><span class="p">:</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">img</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">UnsupportedImageShapeException</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">byteorder</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;=&quot;</span><span class="p">,</span> <span class="s">&quot;|&quot;</span><span class="p">]:</span>
                <span class="n">dt</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">newbyteorder</span><span class="p">(</span><span class="s">&quot;&gt;&quot;</span><span class="p">)</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dt</span><span class="p">)</span>
                <span class="n">byteorder</span> <span class="o">=</span> <span class="s">&quot;&gt;&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">byteorder</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">byteorder</span>

            <span class="n">endianness</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;&gt;&quot;</span><span class="p">:</span> <span class="s">&quot;,arch=bigendian&quot;</span><span class="p">,</span>
                          <span class="s">&quot;&lt;&quot;</span><span class="p">:</span> <span class="s">&quot;,arch=littleendian&quot;</span><span class="p">}[</span><span class="n">byteorder</span><span class="p">]</span>
            <span class="p">(</span><span class="n">ydim</span><span class="p">,</span> <span class="n">xdim</span><span class="p">)</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">arr_str</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">tostring</span><span class="p">()</span>

            <span class="n">itemsize</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">*</span> <span class="mi">8</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">bitpix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ImgCode</span><span class="p">[</span><span class="n">img</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">UnsupportedDatatypeException</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

            <span class="n">option</span> <span class="o">=</span> <span class="s">&quot;[xdim=</span><span class="si">%d</span><span class="s">,ydim=</span><span class="si">%d</span><span class="s">,bitpix=</span><span class="si">%d%s</span><span class="s">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">xdim</span><span class="p">,</span> <span class="n">ydim</span><span class="p">,</span>
                                                        <span class="n">bitpix</span><span class="p">,</span> <span class="n">endianness</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;array &quot;</span> <span class="o">+</span> <span class="n">option</span><span class="p">,</span> <span class="n">arr_str</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set_frameinfo</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="p">[</span><span class="n">frame</span><span class="p">][</span><span class="s">&#39;user_array&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">img</span>
            <span class="k">except</span> <span class="n">XpaException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">XpaException</span><span class="p">(</span>
                    <span class="s">&quot;XPA: {0} : Problem loading array into frame {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">frame</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="ds9.zoomtofit"><a class="viewcode-back" href="../../api/imexam.ds9_viewer.ds9.html#imexam.ds9_viewer.ds9.zoomtofit">[docs]</a>    <span class="k">def</span> <span class="nf">zoomtofit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;convenience function for zoom&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zoom</span><span class="p">(</span><span class="s">&quot;to fit&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ds9.zoom"><a class="viewcode-back" href="../../api/imexam.ds9_viewer.ds9.html#imexam.ds9_viewer.ds9.zoom">[docs]</a>    <span class="k">def</span> <span class="nf">zoom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par</span><span class="o">=</span><span class="s">&quot;to fit&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; zoom using the specified command in par</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        par: string</span>
<span class="sd">            it can be a number (ranging 0 to 8 effectively), and successive calls continue zooming in the same direction</span>
<span class="sd">            it can be two numbers &#39;4 2&#39;, which specify zoom on different axis</span>
<span class="sd">            if can be to a specific value &#39;to 8&#39; or &#39;to fit&#39;</span>
<span class="sd">            it can be &#39;open&#39; to open the dialog box</span>
<span class="sd">            it can be &#39;close&#39; to close the dialog box (only valid if the box is already open)</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        zoom(&quot;0.1&quot;)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;zoom </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">par</span><span class="p">)))</span>
        <span class="k">except</span> <span class="n">XpaException</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span>
                <span class="s">&quot;XPA problem with zoom (probably your zoom window is already closed)&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ds9.show_commands"><a class="viewcode-back" href="../../api/imexam.ds9_viewer.ds9.html#imexam.ds9_viewer.ds9.show_commands">[docs]</a>    <span class="k">def</span> <span class="nf">show_commands</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;print the available XPA commands&quot;&quot;&quot;</span>

        <span class="k">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>  <span class="c"># with no arguments supplied, XPA returns options</span>
</div></div>
<span class="kn">import</span> <span class="nn">atexit</span>
<span class="n">atexit</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">ds9</span><span class="o">.</span><span class="n">_purge_tmp_dirs</span><span class="p">)</span>
<span class="n">atexit</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">ds9</span><span class="o">.</span><span class="n">_stop_running_process</span><span class="p">)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper"><h3>Page Contents</h3>


        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right"> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2015, Megan Sosey.<br/>
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.2.2. &nbsp;
    Last built 01 May 2015. <br/>
  </p>
</footer>
  </body>
</html>