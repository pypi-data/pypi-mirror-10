(function(){if(typeof define==="function"&&define.amd){define(["d3"],a)}else{a(this.d3)}function a(y){var b=Math.random;y.layout.cloud=function i(){var A=256,N=256,I=[A,N],K=null,F=s,H=t,c=e,z=m,E=m,Q=u,G=p,M=v,J=[],L=Infinity,P=y.dispatch("word","end"),D=null,O=false,B={};B.start=function(){var T=o((I[0]>>5)*I[1]),V=null,X=J.length,S=-1,R=[],W=J.map(function(Z,Y){Z.text=F.call(this,Z,Y);Z.font=H.call(this,Z,Y);Z.style=z.call(this,Z,Y);Z.weight=E.call(this,Z,Y);Z.rotate=Q.call(this,Z,Y);Z.size=~~c.call(this,Z,Y);Z.padding=G.call(this,Z,Y);return Z}).sort(function(Z,Y){return Y.size-Z.size});if(D){clearInterval(D)}D=setInterval(U,0);U();return B;function U(){var ac=Date.now(),Y,ab,Z;while(Date.now()-ac<L&&++S<X&&D){var aa=W[S];if(K){Y=aa.x=K[0];ab=aa.y=K[1]}else{Y=aa.x=(I[0]*(b()+0.5))>>1;ab=aa.y=(I[1]*(b()+0.5))>>1}Z=S+1;r(aa,W,S);while(aa.hasText){if(C(T,aa,V)){R.push(aa);P.word(aa);if(V){k(V,aa)}else{V=[{x:aa.x+aa.x0,y:aa.y+aa.y0},{x:aa.x+aa.x1,y:aa.y+aa.y1}]}aa.x-=I[0]>>1;aa.y-=I[1]>>1;break}else{delete aa.sprite;aa.sprite=null;aa.x=Y;aa.y=ab;aa.size=Z<W.length?W[Z++].size:aa.size-(aa.size>>3);if(~~aa.size>0){r(aa,W,S)}else{aa.hasText=false}}}}if(S>=X){B.stop();P.end(R,V)}}};B.stop=function(){if(D){clearInterval(D);D=null}return B};function C(V,ao,U){var S=[{x:0,y:0},{x:I[0],y:I[1]}],am=ao.x,al=ao.y,R=Math.sqrt(I[0]*I[0]+I[1]*I[1]),ac=M(I),ad=b()<0.5?1:-1,ab=-ad,ai,aa,Y;while(ai=ac(ab+=ad)){aa=~~ai[0];Y=~~ai[1];if(Math.min(Math.abs(aa),Math.abs(Y))>=R){break}ao.x=am+aa;ao.y=al+Y;if(ao.x+ao.x0<0||ao.y+ao.y0<0||ao.x+ao.x1>I[0]||ao.y+ao.y1>I[1]){if(!O){continue}}if(!U||!l(ao,V,I[0])){if(!U||h(ao,U)){var ag=ao.sprite,Z=ao.width>>5,af=I[0]>>5,T=ao.x-(Z<<4),ae=T&127,an=32-ae,ak=ao.y1-ao.y0,X=(ao.y+ao.y0)*af+(T>>5),W;for(var ah=0;ah<ak;ah++){W=0;for(var aj=0;aj<=Z;aj++){V[X+aj]|=(W<<an)|(aj<Z?(W=ag[ah*Z+aj])>>>ae:0)}X+=af}delete ao.sprite;return true}}}return false}B.timeInterval=function(R){return arguments.length?(L=R===null?Infinity:R,B):L};B.words=function(R){return arguments.length?(J=R,B):J};B.size=function(R){if(!arguments.length){return I}if(!R[0]||R[0]<0){R[0]=A}if(!R[1]||R[1]<1){R[1]=N}return arguments.length?(I=[+R[0],+R[1]],B):I};B.font=function(R){return arguments.length?(H=y.functor(R),B):H};B.fontStyle=function(R){return arguments.length?(z=y.functor(R),B):z};B.fontWeight=function(R){return arguments.length?(E=y.functor(R),B):E};B.rotate=function(R){return arguments.length?(Q=y.functor(R),B):Q};B.text=function(R){return arguments.length?(F=y.functor(R),B):F};B.spiral=function(R){return arguments.length?(M=d[R]||R,B):M};B.fontSize=function(R){return arguments.length?(c=y.functor(R),B):c};B.padding=function(R){return arguments.length?(G=y.functor(R),B):G};B.random=function(R){return arguments.length?(b=R,B):b};B.startPoint=function(R){if(!arguments.length){return K}K=[+R[0],+R[1]];return B};B.overflow=function(R){if(!arguments.length){return O}O=y.functor(R);return B};return y.rebind(B,P,"on")};function s(c){return c.text}function t(){return"serif"}function m(){return"normal"}function e(c){return Math.sqrt(c.value)}function u(){return(~~(b()*6)-3)*30}function p(){return 1}function r(U,V,S){if(U.sprite){return}w.clearRect(0,0,(g<<5)/j,n/j);var E=0,D=0,G=0,K=V.length;--S;while(++S<K){U=V[S];w.save();w.font=U.style+" "+U.weight+" "+~~((U.size+1)/j)+"px "+U.font;var F=w.measureText(U.text+"m").width*j,R=U.size<<1;if(U.rotate){var N=Math.sin(U.rotate*x),C=Math.cos(U.rotate*x),z=F*C,H=F*N,T=R*C,B=R*N;F=(Math.max(Math.abs(z+B),Math.abs(z-B))+31)>>5<<5;R=~~Math.max(Math.abs(H+T),Math.abs(H-T))}else{F=(F+31)>>5<<5}if(R>G){G=R}if(E+F>=(g<<5)){E=0;D+=G;G=0}if(D+R>=n){break}w.translate((E+(F>>1))/j,(D+(R>>1))/j);if(U.rotate){w.rotate(U.rotate*x)}w.fillText(U.text,0,0);if(U.padding){w.lineWidth=2*U.padding,w.strokeText(U.text,0,0)}w.restore();U.width=F;U.height=R;U.xoff=E;U.yoff=D;U.x1=F>>1;U.y1=R>>1;U.x0=-U.x1;U.y0=-U.y1;U.hasText=true;E+=F}var I=w.getImageData(0,0,(g<<5)/j,n/j).data,J=[];while(--S>=0){U=V[S];if(!U.hasText){continue}var F=U.width,A=F>>5,R=U.y1-U.y0;for(var Q=0;Q<R*A;Q++){J[Q]=0}E=U.xoff;if(E===null){return}D=U.yoff;var c=0,P=-1;for(var O=0;O<R;O++){for(var Q=0;Q<F;Q++){var M=A*O+(Q>>5),L=I[((D+O)*(g<<5)+(E+Q))<<2]?1<<(31-(Q%32)):0;J[M]|=L;c|=L}if(c){P=O}else{U.y0++;R--;O--;D++}}U.y1=U.y0+P;U.sprite=J.slice(0,(U.y1-U.y0)*A)}}function l(K,D,H){H>>=5;var J=K.sprite,G=K.width>>5,c=K.x-(G<<4),F=c&127,C=32-F,B=K.y1-K.y0,E=(K.y+K.y0)*H+(c>>5),I;for(var z=0;z<B;z++){I=0;for(var A=0;A<=G;A++){if(((I<<C)|(A<G?(I=J[z*G+A])>>>F:0))&D[E+A]){return true}}E+=H}return false}function k(A,B){var z=A[0],c=A[1];if(B.x+B.x0<z.x){z.x=B.x+B.x0}if(B.y+B.y0<z.y){z.y=B.y+B.y0}if(B.x+B.x1>c.x){c.x=B.x+B.x1}if(B.y+B.y1>c.y){c.y=B.y+B.y1}}function h(z,c){return z.x+z.x1>c[0].x&&z.x+z.x0<c[1].x&&z.y+z.y1>c[0].y&&z.y+z.y0<c[1].y}function v(c){var z=c[0]/c[1];return function(A){return[z*(A*=0.1)*Math.cos(A),A*Math.sin(A)]}}function q(B){var z=4,A=z*B[0]/B[1],c=0,C=0;return function(E){var D=E<0?-1:1;switch((Math.sqrt(1+4*D*E)-D)&3){case 0:c+=A;break;case 1:C+=z;break;case 2:c-=A;break;default:C-=z;break}return[c,C]}}function o(A){var c=[],z=-1;while(++z<A){c[z]=0}return c}var x=Math.PI/180,g=1<<11>>5,n=1<<11,f,j=1;if(typeof document!=="undefined"){f=document.createElement("canvas");f.width=1;f.height=1;j=Math.sqrt(f.getContext("2d").getImageData(0,0,1,1).data.length>>2);f.width=(g<<5)/j;f.height=n/j}else{if(!!Canvas){f=new Canvas(g<<5,n)}}var w=f.getContext("2d"),d={archimedean:v,rectangular:q};w.fillStyle=w.strokeStyle="red";w.textAlign="center"}})();